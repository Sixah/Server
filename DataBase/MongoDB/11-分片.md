## 一 分片的概念
当Mongo的数据量非常大之后，建议将数据进行拆分，放置在不同的Mongo服务中，这就是分片。  
工具mongos在查询数据时，会先询问configsvr，得到数据在哪个shard上，configsvr不存储真正的数据，存储的是数据的meta信息（元信息-某条数据在哪个片上）。  
分片的要素：
- 要有N>-2个mongod服务做片节点
- 要有configsvr维护meta信息
- 要设定好数据的分片规则，configsvr才能维护
- 要启动mongos做路由
## 二 分片操作
服务端操作：
```
step1: 启动两台在不同端口上的mongod
mongod --dbpath /data/mgd1   --logpath /logs/mgd1.log --fork --port 27017
mongod --dbpath /data/mgd2   --logpath /logs/mgd2.log --fork --port 27018

step2：启动一台configsvr
mongod --dbpath /data/svr   --logpath /logs/svr.log --fork --port 27020 --configsvr

step3:配置路由mongos(配置哪台configsvr为这个路由服务)
mongos --dbpath /data/mongos   --logpath /logs/mongos.log --fork --port 30000 --configdb 192.168.1.202:27020
sh.enableSharding("test")           // 指定要分片的数据库
sh.shardCollection('test.user', uid);   //指定分片的片键（按照uid切片存储）

```
客户端连接
```
# 此时客户端需要连接30000这个路由端口
mongo 127.0.0.1:30000/test

# 增加片
sh.addShard('192.168.1.202:27017')
sh.addShard('192.168.1.202:27018')
sh.status()
```


注意：Mongo并不是从单篇文档的级别绝对平均的散落在各个片上，而是N篇文档形成一个块chunk，优先放在某个片上，当这片上的chunk比另一个片的chubk区别比较大时(>=3)，会把本片上的chunk移动到另一个片上。  
每个chunk默认是64M（db.settings.find()），可以通过修改chunk大小来强制分片(db.settings.save({_id:'chunksize'},{$set:{value:4}}))(这里的db是config服务器)

## 三 手动分片
可以预定义一个规则，每N调数据形成1个块，预计分片M个chunk，M个chunk分配在不同的片上，以后的数据可以直接插入各自预先分配好的chunk，不再来回移动。  
```
在路由服务器上操作：
sh.shardCollection('test.user',{uid:1})

# 预先在1K，2K...40K这样的界限切好chunk（空的），这些chunk均匀的分配到片上
for(var i = 1; i <= 40; i++>) {sh.splitAt('test.uid', {uid: i*1000})}

# 此时再添加数据，数据会添加到预先分配好的片上
```
