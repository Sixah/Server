## 六  分布式事务

#### 6.1 分布式事务简介

当前只有InnoDB支持分布式事务，一个分布式事务涉及多个行动，每个行动都是事务性的，所有行动必须一起成功完成，或者一起被回滚。  

MySQL的分布式事务涉及一到多个资源管理器和一个事务管理器：
- RM资源管理器：提供通向事务资源的途径。数据库服务器是一种资源管理器，可以提交、回滚由RM管理的事务，如：多台MySQL作为资源管理器
- TM事务管理器：TM与管理每个事务的RNs通信，用于协调作每个行动。在一个分布式事务中，哥哥单事务均是分布式事务的分支事务，分布式事务和各分支铜鼓一种命名方法标识

要执行一个分布式事务，必须知道这个分布式事务涉及了哪些资源管理器，并且把每个资源管理器的事务执行到事务可以被提交或回滚时。根据每个资源管理器报告的有关执行情况的内容，这些分支事务必须作为一个原子性操作全部提交或回滚。  

要管理一个分布式事务，必须考虑任何组件或连接网络可能会出现故障。  

用于执行分布式事务的过程使用两阶段提交，发生时间在由分布式事务的各个分支需要进行的西东已经被执行：
- 阶段1：所有分支预备好。即它们被TM告知要准备提交
- 阶段2：TM告知RMs是否要提交或者回滚。

#### 6.2 分布式事务使用
```
终端1：                                             终端2：
---------------------------------------------------------------------------------------------------------

步骤1：分别启动分布式事务中的一个分支事务，test为gtrid，db1和db2位bqual
xa start 'test', 'db1';                             xa start 'test', 'db2';
insert into user(name) values('zs');                update order set last_update=now() where oid=3;
---------------------------------------------------------------------------------------------------------

步骤2：分别对事务进行第一阶段提交，进入prepare状态
xa end 'test', 'db1';                               xa end 'test', 'db2';
---------------------------------------------------------------------------------------------------------

步骤3：查看当前分支状态
xa recover;                                         xa recover;
---------------------------------------------------------------------------------------------------------

步骤4：分别提交各自的分支事务
xa commit 'test', 'db1';                            xa commit 'test', 'db2';
---------------------------------------------------------------------------------------------------------
```

#### 6.3 MySQL分布式的隐患

如果分支事务达到prepare状态时，数据库异常重新启动，此时仍然可以对分支事务进行提交、回滚，但是提交的事务没有写binlog，存在隐患：使用binlog恢复时可能会丢失数据，也会引起主从数据不一致。  

