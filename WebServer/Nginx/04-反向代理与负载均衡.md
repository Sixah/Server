## 一 反向代理简介
反向代理举例：
比如现在有一台服务器，内部启用了一些web服务器，分别位于不同的端口上，那么用户如何通过域名直接访问呢？

![](/images/server/nginx01.png)

在服务器内部，nginx将用户的请求代理给对应的web服务器，web服务器将数据通过nginx传回给客户端，这个过程称之为反向代理。


## 二 负载均衡

由于流量很大，往往同一个服务由多台服务器负载执行，那么如何避免某个服务器一直在处理请求，过于繁忙，而造成其余服务器闲置，以达到各个服务器负载均衡呢？  

配置如下：
```
# 配置负载名
upstream imgserver {
    192.168.1.200:81 weight=1 max_fails=2 fail_timeout=3;
    192.168.1.200:82 weight=1 max_fails=2 fail_timeout=3;
}

# 第一台图片负载服务器
server {
    listen 81;
    server_name localhost;
    root html;
}

# 第二台图片负载服务器
server {
    listen 82;
    server_name localhost;
    root html;
}

# 配置负载数据
server {
    listen 80;
    server_name localhost;
    root html;
    .....
    location ~* \.(jpg|jpeg|git|png){
        proxy_pass http://imageserver;
    }
}
```

## 三 负载均衡策略

Nginx的负载均衡策略可以划分为两大类：
- 内置策略：轮询、加权轮询、IP hash三种
- 扩展策略：url hash、fair等多种策略
  
内置策略会默认被编译进Nginx内核，使用时只需要在Nginx服务器配置中设置相关参数即可，扩展策略不会编译进Nginx内核，需要手动将第三方模块编译到Nginx内核。  

轮询策略最简单，就是将每个前端请求按顺序（时间或者排列次序）逐一分配到不同的后端节点上，同时会自动排除出现问题的后端节点。  

加权轮询策略就是在基本的轮询上考虑各后端节点接受请求的权重，指定各个后端节点被轮询到的几率，适用于后端节点性能不均的情况。  

IP hash策略，是将前端的访问IP进行hash操作，根据hash结果将请求分配给不同的后端节点，可以视为特殊的轮询策略，通过Nginx的实现，每个前端访问IP都会访问固定的一个后端节点。这样做可以比年前端用户在后端多个节点上出现session共享问题。  

`url hash`策略和`IP hash`相近，不同之处是`url hash`是对前端请求的url进行hash操作，优点是：如果后端有缓存服务器，它能够提高缓存效率，同时解决session问题，缺点是，如果后端节点出现异常，则不能自动排除节点。  

`fair`是从另一个角度实现负载均衡：会将前端请求转发到一个最近负载最小的后台节点。判断负载最小的办法：通过后端节点对请求的响应时间判断负载。  